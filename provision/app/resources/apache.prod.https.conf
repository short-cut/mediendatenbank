<VirtualHost *:443>

    ServerName test.tcut.local

    DocumentRoot /var/www/application/public
    DirectoryIndex index.php

    # Request size limit in bytes, 0 to disable
    # LimitRequestBody 0

    # Request timeout limit in seconds, 0 to disable
    # TimeOut %TIMEOUT%

    # Enabled for Dev environment
    #LogLevel debug

    # "web" folder is what we expose to the world, all rewrite rules further down is relative to it.
    <Directory /var/www/application/public>
        Options FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/apache.crt
    SSLCertificateKeyFile /etc/ssl/private/apache.key


    # Environment.
    # Possible values: "prod" and "dev" out-of-the-box, other values possible with proper configuration
    # Defaults to "prod" if omitted (uses SetEnvIf so value can be used in rewrite rules)
    SetEnv APP_ENV prod

    # enable a feature here with the key
    # SetEnv SYMFONY__ETECTURE__FEATURE "eguide"

    # Optional: Whether to use debugging.
    # Possible values: 0, 1 or ""
    # Defaults to enabled if SYMFONY_ENV is set to "dev" if env value is omitted or empty
    #if[SYMFONY_DEBUG] SetEnv SYMFONY_DEBUG "%SYMFONY_DEBUG%"

    # Optional: Whether to use Symfony's builtin HTTP Caching Proxy.
    # Disable it if you are using an external reverse proxy (e.g. Varnish)
    # Possible values: 0, 1 or ""
    # Defaults to disabled if SYMFONY_ENV is set to "dev" or SYMFONY_TRUSTED_PROXIES is set,
    # and if this env value is omitted or empty
    #if[SYMFONY_HTTP_CACHE] SetEnv SYMFONY_HTTP_CACHE "%SYMFONY_HTTP_CACHE%"
    SetEnv SYMFONY_HTTP_CACHE 0

    # Optional: Defines the proxies to trust
    # Needed when using Varnish as proxy, if so disable SYMFONY_HTTP_CACHE.
    # Separate entries by a comma, example: "ip1,ip2"
    # Defaults to not be set if env value is omitted or empty
    # SetEnv SYMFONY_TRUSTED_PROXIES "%SYMFONY_TRUSTED_PROXIES%"

    # TIP: There are many more environment variables supported by eZ Platform. However unlike those listed above
    #      they should in most cases rather be set in the environment then in vhost config to make sure cronjobs
    #      and cli command usage takes them into account as well.

    <IfModule mod_rewrite.c>
        RewriteEngine On

        # For FastCGI mode or when using PHP-FPM, to get basic auth working.
        RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

        # Cluster/streamed files rewrite rules. Enable on cluster with DFS as a binary data handler
        # RewriteCond %{ENV:BINARY_DATA_HANDLER} "dfs"
        # RewriteRule ^/var/([^/]+/)?storage/images(-versioned)?/.* /index.php [L]

        RewriteRule ^/bundles/ - [L]
        RewriteRule ^/assets/ - [L]
        RewriteRule ^/build/ - [L]

        # Makes it possible to placed your favicon and robots.txt at the root of your web folder
        RewriteRule ^/favicon\.ico - [L]
        RewriteRule ^/robots\.txt - [L]
        RewriteRule ^/sitemap\.xml - [L]
        RewriteRule ^/manifest\.json - [L]
        RewriteRule ^/service-worker\.js - [L]
        RewriteRule ^/_static/.*\.html - [L]

        # Additional Assetic rules for environments different from dev,
        # remember to run php bin/console assetic:dump --env=prod
        RewriteCond %{ENV:APP_ENV} !^(dev)
        RewriteRule ^/(css|js|fonts?)/.*\.(css|js|otf|eot|ttf|svg|woff) - [L]
        RewriteRule ^/(build|images)/.*\.(css|js|otf|eot|ttf|svg|woff|jpg|jpeg|png|svg|ico|webp|avif) - [L]

        # Disable .php(3) and other executable extensions in the var directory
        RewriteRule ^/build/.*(?i)\.(php3?|phar|phtml|sh|exe|pl|bin)$ - [F]

        # Prevent access to website with direct usage of app.php in URL
        RewriteRule ^/(.+/)?index\.php - [R=404,L]

        RewriteRule .* /index.php
    </IfModule>

    # using expires header -> we have to remove the other cache header
    <IfModule mod_headers.c>
        Header unset ETag
        Header unset Last-Modified
    </IfModule>

    AddType image/webp .webp
    <IfModule mod_expires.c>
        ExpiresActive on
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/avif "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType text/javascript "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
    </IfModule>


    # Enable gzip encoding
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain text/css application/json text/javascript application/javascript text/xml application/xml application/xml+rss
        # NOTE: Using gzip on text/html can be a security issue. See http://breachattack.com.
    </IfModule>

    ErrorLog /var/log/apache2/humboldt-ibexa_error.log
    CustomLog /var/log/apache2/humboldt-ibexa_access.log combined

</VirtualHost>
